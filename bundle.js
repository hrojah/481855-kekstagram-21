(()=>{"use strict";(()=>{const e={enter:"Enter",esc:"Escape"};window.utils={onPressEnter:(t,n)=>{t.key===e.enter&&n(t)},onPressEsc:(t,n)=>{t.key===e.esc&&(t.preventDefault(),n())},debounce:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e.apply(...n)}),500)}},KEYDOWN:e}})(),(()=>{const e=(e,t,n,r,o)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{200===s.status?r(s.response):o(`Статус ответа: ${s.status} ${s.statusText}`)})),s.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{o(`Запрос не успел выполнится за ${s.timeout} мс`)})),s.timeout=1e4,s.open(e,t),s.send(n)};window.api={load:(t,n)=>{e("GET","https://21.javascript.pages.academy/kekstagram/data",null,t,n)},upload:(t,n,r)=>{e("POST","https://21.javascript.pages.academy/kekstagram/",t,n,r)}}})(),(()=>{let e;const t=document.querySelector("#picture").content.querySelector("a"),n=document.querySelector("#error").content.querySelector("section"),r=document.querySelector(".img-filters"),o=document.querySelector(".pictures"),s=e=>{const n=t.cloneNode(!0);return n.id=e.id,n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__likes").textContent=e.likes,n.querySelector(".picture__comments").textContent=e.comments.length,n},i=e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.append(s(e[n]));o.append(t)};window.api.load((t=>{e=t.map(((e,t)=>(e.id=t,e))),i(e),r.classList.remove("img-filters--inactive"),window.preview.initPictureHandlers()}),(e=>{const t=n.cloneNode(!0),r=t.querySelector(".error__inner"),o=t.querySelector(".error__button");r.removeChild(o),r.style.width="700px",t.querySelector(".error__title").textContent=e,window.form.main.append(t)})),window.gallery={pictures:o,getPhotos:()=>e,createPictures:i}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".comments-loader"),n=e.querySelector(".social__comments"),r=e.querySelector(".social__footer-text"),o=e.querySelector(".big-picture__cancel"),s=e.querySelector(".big-picture__img img"),i=e.querySelector(".likes-count"),c=e.querySelector(".social__caption"),l=e.querySelector(".comments-count"),a=e.querySelector(".social__comment-count");let d;const u=e=>{const t=document.createElement("li"),n=document.createElement("img"),r=document.createElement("p");return t.classList.add("social__comment"),n.classList.add("social__picture"),r.classList.add("social__text"),t.append(n,r),n.src=e.avatar,n.alt=e.name,r.textContent=e.message,t},m=()=>{window.overlay.body.classList.remove("modal-open"),e.classList.add("hidden"),r.value="",n.innerHTML="",t.classList.remove("hidden"),document.removeEventListener("keydown",window.utils.onPressEsc),t.removeEventListener("click",v),t.removeEventListener("keydown",window.utils.onPressEnter)},w=n=>{window.overlay.body.classList.add("modal-open");const r=window.gallery.getPhotos(),o=parseInt(n.target.closest(".picture").id,10);f(r[o]),e.classList.remove("hidden"),document.addEventListener("keydown",(e=>{window.utils.onPressEsc(e,m)})),t.addEventListener("click",v),t.addEventListener("keydown",(e=>{window.utils.onPressEnter(e,v)}))},v=()=>{const e=document.querySelectorAll(".social__comment").length,r=e+5,o=d.slice(e,r),s=document.createDocumentFragment();for(let e=0;e<o.length;e++)s.appendChild(u(o[e]));a.textContent=`${r} из ${d.length} комментариев`,n.append(s),o.length<5&&(a.textContent=`${d.length} из ${d.length} комментариев`,t.classList.add("hidden"))},f=e=>{s.src=e.url,i.textContent=e.likes,c.textContent=e.description,l.textContent=e.comments.length,d=e.comments,v(e.comments)};o.addEventListener("click",m),o.addEventListener("keydown",(e=>{window.utils.onPressEnter(e,m)})),window.preview={initPictureHandlers:()=>{document.querySelectorAll(".picture").forEach((e=>{e.addEventListener("click",w),e.addEventListener("keydown",(e=>{window.utils.onPressEnter(e,w)}))}))}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.body,n=document.querySelector("#upload-file"),r=document.querySelector(".img-upload__overlay"),o=r.querySelector("#upload-cancel"),s=document.querySelector(".text__description"),i=document.querySelector(".img-upload__image"),c=e=>{e.key===window.utils.KEYDOWN.esc&&(e.target===window.form.hashtagsText||e.target===s?e.preventDefault():(e.preventDefault(),l()))},l=()=>{r.classList.add("hidden"),t.classList.remove("modal-open"),document.removeEventListener("keydown",c),window.effects.scaleSmaller.removeEventListener("click",window.effects.declineScale),window.effects.scaleBigger.removeEventListener("click",window.effects.increaseScale),n.value="",window.effects.imgPreview.style.transform="scale(1)",window.effects.imgPreview.style.filter="",window.effects.imgPreview.className="",window.form.hashtagsText.innerHTML="",window.form.form.reset()};n.addEventListener("change",(()=>{(()=>{const t=n.files[0],r=t.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{i.src=e.result})),e.readAsDataURL(t)}})(),r.classList.remove("hidden"),t.classList.add("modal-open"),window.effects.filterScale.classList.add("hidden"),window.effects.scaleSmaller.addEventListener("click",window.effects.declineScale),window.effects.scaleBigger.addEventListener("click",window.effects.increaseScale),document.addEventListener("keydown",c)})),o.addEventListener("click",(()=>{l()})),o.addEventListener("keydown",(e=>{window.utils.onPressEnter(e,l)})),window.overlay={closeOverlay:l,body:t}})(),(()=>{const e={chrome:"effects__preview--chrome",sepia:"effects__preview--sepia",marvin:"effects__preview--marvin",phobos:"effects__preview--phobos",heat:"effects__preview--heat"},t={"effects__preview--chrome":{filter:"grayscale",unit:"",min:0,max:1},"effects__preview--sepia":{filter:"sepia",unit:"",min:0,max:1},"effects__preview--marvin":{filter:"invert",unit:"%",min:0,max:100},"effects__preview--phobos":{filter:"blur",unit:"px",min:0,max:3},"effects__preview--heat":{filter:"brightness",unit:"",min:1,max:3}},n=document.querySelector(".img-upload__preview img"),r=document.querySelector(".scale__control--value"),o=document.querySelector(".img-upload__effect-level"),s=o.querySelector(".effect-level__value"),i=o.querySelector(".effect-level__depth"),c=o.querySelector(".effect-level__pin"),l=document.querySelector(".scale__control--smaller"),a=document.querySelector(".scale__control--bigger"),d=()=>{const e=parseInt(s.value,10);n.className in t?n.style.filter=((e,t)=>(t=((e,t,n)=>e*(n-t)/100+t)(t,e.min,e.max),`${e.filter}(${t}${e.unit})`))(t[n.className],e):n.style.filter=""};c.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX};const n=e=>{e.preventDefault();let n=t.x-e.clientX;t={x:e.clientX};let r=c.offsetLeft-n;r<0?r=0:r>453&&(r=453),c.style.left=r+"px",i.style.width=r+"px",s.value=r/453*100,d()},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)})),c.addEventListener("mouseup",d),window.effects={scaleValue:r,filterScale:o,scaleSmaller:l,scaleBigger:a,imgPreview:n,declineScale:()=>{const e=parseInt(r.value,10);if(e>25){const t=e-25;r.value=t+"%";const o=t/100;n.style.transform=`scale(${o})`}},increaseScale:()=>{const e=parseInt(r.value,10);if(e<100){const t=e+25;r.value=t+"%";const o=t/100;n.style.transform=`scale(${o})`}},effectChangeHandler:t=>{t.target.matches("input[type='radio']")&&(s.value=100,c.style.left="453px",i.style.width="453px",n.style.transform="scale(1)",r.value="100%",t.target.value in e?(o.classList.remove("hidden"),n.removeAttribute("style"),n.className=e[t.target.value]):"none"===t.target.value&&(o.classList.add("hidden"),n.className="",n.style.filter=""))},effectLevelHandler:d}})(),(()=>{const e=/#[a-zA-Zа-яА-ЯёЁ0-9]{1,19}/i,t="не больше 5 хэштегов",n="хэштеги не должны повторяться",r="недопустимые символы",o="длина хэштега не более 20 символов",s="",i=document.querySelector("main"),c=document.querySelector("#error").content.querySelector("section"),l=document.querySelector("#success").content.querySelector("section"),a=document.querySelector(".img-upload__form"),d=a.querySelector(".text__hashtags"),u=(e,t)=>{for(let n=0;n<t.length;n++)if(e===t[n])return!0;return!1},m=t=>!e.test(t),w=e=>e.length>20,v=e=>{d.setCustomValidity(e),d.reportValidity()},f=()=>{const e=l.cloneNode(!0),t=e.querySelector(".success__button");t.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",(t=>{window.utils.onPressEsc(t,(()=>{e.remove()}))})),e.addEventListener("click",(t=>{t.target.closest(".success__inner")||e.remove()})),t.addEventListener("blur",(()=>t.focus())),i.append(e)},p=()=>{const e=c.cloneNode(!0),t=e.querySelector(".error__button");t.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",(t=>{window.utils.onPressEsc(t,(()=>{e.remove()}))})),e.addEventListener("click",(t=>{t.target.closest(".error__inner")||e()})),t.addEventListener("blur",(()=>t.focus())),i.append(e)};d.addEventListener("input",(()=>{v(s)})),a.addEventListener("submit",(e=>{e.preventDefault();const i=(()=>{const e=d.value.toLowerCase().trim();if(!e)return s;const i=e.split(" ");if(i.length>5)return t;for(let e=0;e<i.length;e++){const t=i[e];if(u(t,i.slice(e+1)))return n;if(m(t))return r;if(w(t))return o}return s})();v(i),i===s&&window.api.upload(new FormData(a),f,p),window.overlay.closeOverlay(),a.reset()})),a.addEventListener("change",window.effects.effectChangeHandler),window.form={hashtagsText:d,form:a,main:i}})(),(()=>{const e=document.querySelector("#filter-default"),t=document.querySelector("#filter-discussed"),n=document.querySelector("#filter-random"),r=document.querySelector(".img-filters"),o=e=>{r.querySelectorAll(".img-filters__button--active").forEach((e=>{e.classList.remove("img-filters__button--active")})),e.classList.add("img-filters__button--active")},s=()=>{window.gallery.pictures.classList.add("hidden");const e=document.querySelectorAll(".picture");for(let t=0;t<e.length;t++)e[t].remove();window.gallery.pictures.classList.remove("hidden")},i=window.utils.debounce((()=>{o(e),s(),window.gallery.createPictures(window.gallery.getPhotos()),window.preview.initPictureHandlers()})),c=window.utils.debounce((()=>{o(t);const e=window.gallery.getPhotos().slice();s(),window.gallery.createPictures(e.sort(((e,t)=>t.comments.length-e.comments.length))),window.preview.initPictureHandlers()})),l=window.utils.debounce((()=>{o(n);let e=window.gallery.getPhotos().slice();(e=>{for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1)),r=e[n];e[n]=e[t],e[t]=r}})(e),e=e.slice(0,10),s(),window.gallery.createPictures(e),window.preview.initPictureHandlers()}));e.addEventListener("click",i),t.addEventListener("click",c),n.addEventListener("click",l)})()})();